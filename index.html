<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Christmas Surprise üéÑ</title>

  <style>
    :root{
      --padTop: max(18px, env(safe-area-inset-top));
      --padBottom: max(22px, env(safe-area-inset-bottom));
      --uiScale: 1;
    }

    body{
      margin:0;
      min-height:100vh;
      overflow:hidden; /* ‚úÖ no scroll feeling */
      background:radial-gradient(circle at top,#1c7c54,#0f3624);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      color:white;
      user-select:none;
      position:relative;
      transition: background 900ms ease-in-out;
      padding:
        var(--padTop)
        env(safe-area-inset-right)
        var(--padBottom)
        env(safe-area-inset-left);
    }

    canvas{position:absolute;inset:0;z-index:1;pointer-events:none;}

    .container{
      text-align:center;
      padding:18px 18px 26px;
      position:relative;
      z-index:2;
      width:min(92vw,520px);
      transform: scale(var(--uiScale));
      transform-origin: top center;
      will-change: transform;
    }

    /* ================================
       ‚úÖ LOADER SCREEN
    ================================ */
    .loader{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#1c7c54,#0f3624);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      transition: opacity 450ms ease;
    }
    .loader.hide{ opacity:0; pointer-events:none; }
    .loaderCard{
      width:min(88vw,360px);
      padding:18px 18px 20px;
      border-radius:18px;
      background:rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      box-shadow:0 14px 28px rgba(0,0,0,0.35);
      text-align:center;
    }
    .loaderTitle{ font-size:18px; font-weight:900; color:#ffe9b3; }
    .loaderSub{ margin-top:10px; font-size:15px; opacity:.95; line-height:1.4; }
    .loaderBar{
      margin-top:14px;
      height:10px;
      background:rgba(255,255,255,0.12);
      border-radius:999px;
      overflow:hidden;
    }
    .loaderFill{
      height:100%;
      width:0%;
      background:rgba(255,233,179,0.9);
      border-radius:999px;
      transition: width 250ms ease;
    }

    /* ================================
       ‚úÖ Sound controls
    ================================ */
    .soundBar{
      position:fixed;
      top: calc(var(--padTop) + 8px);
      right: 12px;
      z-index: 50;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:none;
      background:rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.22);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:14px;
      box-shadow:0 10px 18px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(0.98); }
    .btn.on{ color:#ffe9b3; border-color:rgba(255,233,179,0.5); }

    /* ‚úÖ FINAL BACKGROUND */
    body.finalChristmas { background: radial-gradient(circle at top, #ff4d4d, #4d0606); }
    body.finalChristmas canvas { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.25)); }

    body.finalChristmas::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 15% 20%, rgba(255,255,255,0.12), transparent 35%),
        radial-gradient(circle at 85% 30%, rgba(255,255,255,0.10), transparent 40%),
        radial-gradient(circle at 60% 80%, rgba(255,255,255,0.10), transparent 45%);
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 0;
      animation: twinkle 2.4s ease-in-out infinite;
    }
    @keyframes twinkle {
      0%,100% { opacity: 0.65; transform: scale(1); }
      50%     { opacity: 1; transform: scale(1.03); }
    }

    body.finalChristmas::after {
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:0;
      border: 2px solid rgba(255,255,255,0.15);
      box-shadow:
        inset 0 0 0 6px rgba(255,255,255,0.06),
        inset 0 0 40px rgba(255,220,160,0.12),
        0 0 45px rgba(255,255,255,0.08);
      border-radius: 22px;
    }

    /* üïØÔ∏è Candle mode */
    body.candleMode { background: radial-gradient(circle at center, #111 0%, #000 78%); }
    body.candleMode canvas { opacity: 0.35; filter: blur(0.7px); }
    body.candleMode::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(circle at 50% 45%, rgba(255, 200, 130, 0.22), transparent 55%),
        radial-gradient(circle at 50% 45%, rgba(255, 170, 90, 0.12), transparent 70%);
      mix-blend-mode: screen;
      animation: candleGlow 1.25s ease-in-out infinite;
    }
    body.candleMode::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle at center, transparent 42%, rgba(0,0,0,0.82) 100%);
    }
    @keyframes candleGlow { 0%, 100% { opacity: 0.55; transform: scale(1); } 50% { opacity: 1; transform: scale(1.04); } }

    /* Gift box */
    .box{
      font-size: clamp(120px, 18vw, 190px);
      cursor:pointer;
      position:relative;
      animation:float 2.4s ease-in-out infinite,pulseGlow 2.8s ease-in-out infinite;
      filter:drop-shadow(0 15px 25px rgba(0,0,0,.55));
    }
    .box::after{
      content:"";position:absolute;top:50%;left:50%;
      width:210px;height:210px;transform:translate(-50%,-50%);
      border-radius:50%;
      background:radial-gradient(circle,rgba(255,255,255,.25),transparent 70%);
      filter:blur(12px);opacity:.75;z-index:-1;
      animation:aura 2.6s ease-in-out infinite;
    }

    .box.candleLit {
      text-shadow:
        0 0 16px rgba(255, 220, 170, 0.75),
        0 0 40px rgba(255, 170, 90, 0.55),
        0 0 75px rgba(255, 110, 20, 0.25);
      animation:
        float 2.4s ease-in-out infinite,
        candleFlicker 0.16s infinite alternate;
    }
    @keyframes candleFlicker {
      from { filter: drop-shadow(0 18px 38px rgba(255, 160, 70, 0.35)); }
      to   { filter: drop-shadow(0 18px 58px rgba(255, 220, 160, 0.55)); }
    }

    .box.stage1{animation:float 2.4s ease-in-out infinite,pulseGlow 2s ease-in-out infinite,w1 .8s ease-in-out infinite;}
    .box.stage2{animation:float 2.4s ease-in-out infinite,pulseGlow 1.6s ease-in-out infinite,w2 .55s ease-in-out infinite;}
    .box.stage3{animation:float 2.4s ease-in-out infinite,pulseGlow 1.2s ease-in-out infinite,w3 .35s ease-in-out infinite;}
    .box.stage4{animation:float 2.4s ease-in-out infinite,pulseGlow .9s ease-in-out infinite,w4 .2s ease-in-out infinite;}

    @keyframes w1{0%,100%{transform:scale(1.05) rotate(0)}50%{transform:scale(1.07) rotate(-2deg)}}
    @keyframes w2{0%,100%{transform:scale(1.06) rotate(0)}25%{transform:scale(1.08) rotate(-3deg)}50%{transform:scale(1.08) rotate(3deg)}75%{transform:scale(1.07) rotate(-2deg)}}
    @keyframes w3{0%,100%{transform:scale(1.07) rotate(0)}25%{transform:scale(1.1) rotate(-5deg)}50%{transform:scale(1.1) rotate(5deg)}75%{transform:scale(1.09) rotate(-4deg)}}
    @keyframes w4{0%,100%{transform:scale(1.1) rotate(0)}20%{transform:scale(1.15) rotate(-10deg)}50%{transform:scale(1.15) rotate(10deg)}80%{transform:scale(1.12) rotate(-8deg)}}

    .hint{font-size:17px;margin-top:12px;opacity:.95;text-shadow:0 6px 14px rgba(0,0,0,.35);}
    .unlockUI{margin-top:14px;display:none;animation:fadeInUp .5s ease forwards;}
    .unlockText{font-size:18px;font-weight:900;color:#ffe9b3;text-shadow:0 8px 18px rgba(0,0,0,.35);}
    .unlockTip{font-size:15px;margin-top:10px;opacity:.95;}
    .trees{margin-top:10px;font-size:20px;letter-spacing:4px;opacity:0.95;text-shadow:0 6px 14px rgba(0,0,0,.25);}

    .card{
      display:none;margin: 18px auto 0;width: min(92vw, 420px);
      background: rgba(255,255,255,0.14);border: 1px solid rgba(255,255,255,0.22);
      padding: 14px 14px 16px;border-radius: 18px;
      box-shadow: 0 12px 25px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);animation: fadeInUp .7s ease forwards;
    }
    .card img{
      width: 100%;border-radius: 14px;box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      background:white;display:block;transition: opacity 0.35s ease;
    }
    .card .cap{margin-top: 10px;font-size: 16px;font-weight: 800;color:#fff3cd;line-height: 1.4;}

    .bubble{
      position:absolute;left:50%;
      top: max(70px, env(safe-area-inset-top) + 46px);
      transform:translateX(-50%);
      font-size:34px;opacity:0;animation:bubbleFloat 1s ease forwards;
      pointer-events:none;z-index:7;
    }
    @keyframes bubbleFloat{
      0%{opacity:0;transform:translateX(-50%) translateY(12px) scale(.8)}
      40%{opacity:1;transform:translateX(-50%) translateY(-12px) scale(1.05)}
      100%{opacity:0;transform:translateX(-50%) translateY(-55px) scale(1.2)}
    }

    .content{display:none;animation:fadeInUp .8s ease forwards;}
    .pants{display:flex;gap:20px;justify-content:center;margin-top:18px;flex-wrap:wrap;}
    .pants img{
      width:min(42vw,150px);
      border-radius:16px;box-shadow:0 10px 18px rgba(0,0,0,.45);
      background:white;transform:scale(.98);transition:transform .25s ease;
    }

    .messageWrap{margin-top:22px;display:flex;justify-content:center;}
    .message{
      width:min(92vw,420px);background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      padding:16px 18px;border-radius:18px;box-shadow:0 12px 25px rgba(0,0,0,.35);
      backdrop-filter:blur(10px);text-align:center;animation:cutePop .9s ease;
    }
    .message .title{font-size:20px;font-weight:900;color:#ffe9b3;margin-bottom:6px;}
    .message .sub{font-size:16px;font-weight:600;line-height:1.55;color:rgba(255,255,255,.95);}

    .finalLine{
      margin: 14px auto 0;
      width: min(92vw, 420px);
      font-size: 18px;
      font-weight: 900;
      color: #ffe9b3;
      text-shadow: 0 10px 22px rgba(0,0,0,0.45);
      animation: fadeInUp 1s ease forwards;
    }

    .sparkBurst{position:absolute;inset:0;display:none;pointer-events:none;z-index:3;}
    .spark{position:absolute;font-size:24px;animation:burst 900ms ease-out forwards;opacity:0;}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
    @keyframes pulseGlow{0%,100%{filter:drop-shadow(0 15px 25px rgba(0,0,0,.55))}50%{filter:drop-shadow(0 18px 35px rgba(255,255,255,.18))}}
    @keyframes aura{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:.7}50%{transform:translate(-50%,-50%) scale(1.08);opacity:1}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @keyframes cutePop{0%{transform:scale(.85);opacity:0}65%{transform:scale(1.05);opacity:1}100%{transform:scale(1)}}
    @keyframes burst{
      0%{transform:translate(0,0) scale(.8);opacity:0}
      20%{opacity:1}
      100%{transform:translate(var(--x),var(--y)) scale(1.2);opacity:0}
    }

    /* Sleigh */
    .sleigh{
      position:absolute;
      top: 45%;
      left: -80%;
      z-index:9;
      pointer-events:none;
      display:none;
      will-change: transform;
      transform: translate3d(0,0,0);
      backface-visibility:hidden;
    }
    body.finalChristmas .sleigh{ display:block; }

    .sleigh img{
      width: 280px;
      height:auto;
      display:block;
      animation: sleighBob 1.5s ease-in-out infinite;
      will-change: transform;
      transform: translate3d(0,0,0);
    }
    @keyframes sleighBob{
      0%,100% { transform: translateY(0px); }
      50%     { transform: translateY(-8px); }
    }
    .sleigh.fly{
      animation: sleighReal 14s cubic-bezier(.2,.8,.2,1) infinite;
      transform-style: preserve-3d;
    }
    @keyframes sleighReal {
      0%   { transform: translateX(-30vw) translateY(20px) rotate(-6deg) scale(0.95); }
      15%  { transform: translateX(-5vw)  translateY(-10px) rotate(-2deg) scale(0.98); }
      35%  { transform: translateX(35vw)  translateY(-30px) rotate(1deg)  scale(1.03); }
      55%  { transform: translateX(75vw)  translateY(5px)   rotate(3deg)  scale(1.06); }
      70%  { transform: translateX(110vw) translateY(-25px) rotate(1deg)  scale(1.04); }
      85%  { transform: translateX(150vw) translateY(-5px)  rotate(-2deg) scale(1.0); }
      100% { transform: translateX(210vw) translateY(10px)  rotate(2deg)  scale(0.96); }
    }
  </style>
</head>

<body>
  <!-- ‚úÖ Loader -->
  <div id="loader" class="loader">
    <div class="loaderCard">
      <div class="loaderTitle">üéÑ Loading your surprise‚Ä¶</div>
      <div class="loaderSub">Just a second üíõ Santa is packing the gifts üéÅ</div>
      <div class="loaderBar"><div id="loaderFill" class="loaderFill"></div></div>
    </div>
  </div>

  <!-- ‚úÖ Sound controls -->
  <div class="soundBar">
    <button id="tapBtn" class="btn">üîî Tap</button>
    <button id="musicBtn" class="btn">üéµ Music</button>
  </div>

  <canvas id="snow"></canvas>

  <div id="santaSleigh" class="sleigh" aria-hidden="true">
    <img src="sleigh.png" alt="Santa Sleigh">
  </div>

  <div class="container" id="uiRoot">
    <div id="giftBox" class="box">üéÅ</div>
    <div id="hint" class="hint">üéÑ Tap the mystery box üéÑ</div>

    <div id="unlockUI" class="unlockUI">
      <div id="unlockText" class="unlockText">‚ú® A mystery is waiting...</div>
      <div id="unlockTip" class="unlockTip">Tap to reveal üíõ</div>
      <div id="trees" class="trees">‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è</div>
    </div>

    <div id="tapCard" class="card">
      <img id="tapImg" src="" alt="tap image">
      <div id="tapCap" class="cap"></div>
    </div>

    <div id="sparkBurst" class="sparkBurst"></div>

    <div id="giftContent" class="content">
      <div class="pants">
        <img src="pants1.jpg" alt="Pants 1">
        <img src="pants2.jpg" alt="Pants 2">
      </div>

      <div class="messageWrap">
        <div class="message">
          <div class="title">üéÑ Merry Christmas ‚ú®</div>
          <div class="sub">
            Our first Christmas as a married couple‚Ä¶ and you‚Äôre already my favorite gift. üéÑüíõ<br>
            Thank you for loving me, choosing me, and building a home with me.<br>
            Merry Christmas, my husband.
          </div>
        </div>
      </div>

      <div class="finalLine">üéÅ Your Gift is on the Way To You! üíõ</div>
    </div>
  </div>

  <script>
    /* ===========================
       ‚úÖ Auto-fit UI so it NEVER clips
    ============================ */
    function fitUI(){
      const ui = document.getElementById("uiRoot");
      const maxH = window.innerHeight
        - (parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--padTop")) || 18)
        - (parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--padBottom")) || 22);

      // Temporarily reset scale for measurement
      document.documentElement.style.setProperty("--uiScale", 1);
      const rect = ui.getBoundingClientRect();

      // If content taller than screen, shrink down
      const scale = Math.min(1, (maxH / rect.height));
      const nice = Math.max(0.84, scale); // never too small
      document.documentElement.style.setProperty("--uiScale", nice.toFixed(3));
    }

    window.addEventListener("resize", fitUI);
    window.addEventListener("orientationchange", () => setTimeout(fitUI, 250));

    /* ===========================
       ‚úÖ Preload images + loader bar
    ============================ */
    const preloadList = ["wife.jpg","cat.jpg","pants1.jpg","pants2.jpg","sleigh.png"];
    let loaded = 0;

    const loader = document.getElementById("loader");
    const loaderFill = document.getElementById("loaderFill");

    function updateLoader(){
      const p = Math.round((loaded / preloadList.length) * 100);
      loaderFill.style.width = p + "%";
      if (loaded >= preloadList.length){
        setTimeout(() => {
          loader.classList.add("hide");
          fitUI();
        }, 400);
      }
    }

    preloadList.forEach(src => {
      const img = new Image();
      img.onload = () => { loaded++; updateLoader(); };
      img.onerror = () => { loaded++; updateLoader(); };
      img.src = src;
    });

    /* ===========================
       ‚úÖ Sound (iPhone safe: user gesture required)
    ============================ */
    const tapSound = new Audio("tap.mp3");
    tapSound.preload = "auto";

    const music = new Audio("music.mp3");
    music.loop = true;
    music.preload = "auto";

    let tapOn = false;
    let musicOn = false;

    const tapBtn = document.getElementById("tapBtn");
    const musicBtn = document.getElementById("musicBtn");

    tapBtn.addEventListener("click", () => {
      tapOn = !tapOn;
      tapBtn.classList.toggle("on", tapOn);
      tapBtn.textContent = tapOn ? "üîî Tap ON" : "üîî Tap";
      if (tapOn) { tapSound.currentTime = 0; tapSound.play().catch(()=>{}); }
    });

    musicBtn.addEventListener("click", () => {
      musicOn = !musicOn;
      musicBtn.classList.toggle("on", musicOn);
      musicBtn.textContent = musicOn ? "üéµ Music ON" : "üéµ Music";
      if (musicOn) music.play().catch(()=>{});
      else music.pause();
    });

    function playTap(){
      if (!tapOn) return;
      try{
        tapSound.currentTime = 0;
        tapSound.play();
      }catch(e){}
    }

    /* ===========================
       ‚úÖ Tap logic (your original)
    ============================ */
    const TOTAL_TAPS = 5;
    let tapCount = 0;

    const steps = [
      {
        stage: "stage1",
        emoji: "üéÅ",
        showCard: true,
        img: "wife.jpg",
        cap: "üéÅ Surprise!! Your Christmas gift is your <b>WIFE!!</b> üòåüíç<br>(Lucky you üòè)"
      },
      {
        stage: "stage2",
        emoji: "üê±üéÅ",
        showCard: true,
        img: "cat.jpg",
        cap: "üêæ Bonus gift unlocked: <b>AKI</b> üòºüéÑ<br>(the real boss of the house)"
      },
      {
        stage: "stage3",
        emoji: "üïØÔ∏èüéÅ",
        unlockText: "üïØÔ∏è Candle magic‚Ä¶ (don‚Äôt blink)",
        unlockTip: "Tap again‚Ä¶ the spell is working üò≥",
        bubble: "‚ú®"
      },
      {
        stage: "stage4",
        emoji: "üß∏üéÅ",
        unlockText: "üß∏ Cute spell ready‚Ä¶ almost unlocked!",
        unlockTip: "Tap again‚Ä¶ I‚Äôm shaking üò≠",
        bubble: "üß∏"
      }
    ];

    function startSleighNow(){
      const sleigh = document.getElementById("santaSleigh");
      if (!sleigh) return;
      sleigh.classList.remove("fly");
      void sleigh.offsetWidth;
      sleigh.classList.add("fly");
    }

    function openGift() {
      playTap();
      tapCount++;

      const box = document.getElementById("giftBox");
      const hint = document.getElementById("hint");
      const unlockUI = document.getElementById("unlockUI");
      const unlockText = document.getElementById("unlockText");
      const unlockTip = document.getElementById("unlockTip");
      const card = document.getElementById("tapCard");
      const tapImg = document.getElementById("tapImg");
      const tapCap = document.getElementById("tapCap");
      const trees = document.getElementById("trees");

      if (tapCount === 1) {
        hint.style.display = "none";
        unlockUI.style.display = "block";
      }

      trees.textContent =
        "üéÑ".repeat(Math.min(tapCount, TOTAL_TAPS)) +
        "‚ùÑÔ∏è".repeat(Math.max(0, TOTAL_TAPS - tapCount));

      if (tapCount === 3 || tapCount === 4) {
        document.body.classList.add("candleMode");
        box.classList.add("candleLit");
      } else {
        document.body.classList.remove("candleMode");
        box.classList.remove("candleLit");
      }

      if (tapCount >= TOTAL_TAPS) {
        document.body.classList.remove("candleMode");
        box.classList.remove("candleLit");

        document.body.classList.add("finalChristmas");
        startSleighNow();

        unlockText.textContent = "üéÅ Your gift is on the way to you üíõ";
        unlockTip.textContent = "Santa‚Äôs sleigh is delivering it üéÖ‚ú®";

        card.style.display = "none";
        burstSparkles();

        setTimeout(() => {
          box.style.display = "none";
          unlockUI.style.display = "none";
          document.getElementById("giftContent").style.display = "block";
          fitUI();
        }, 650);

        return;
      }

      const step = steps[tapCount - 1];
      box.textContent = step.emoji;
      box.className = "box " + step.stage;

      if (step.showCard) {
        card.style.display = "block";
        tapImg.style.opacity = "0";
        tapImg.src = step.img;
        tapImg.onload = () => { tapImg.style.opacity = "1"; };
        tapCap.innerHTML = step.cap;
      } else {
        card.style.display = "none";
      }

      if (step.unlockText) unlockText.textContent = step.unlockText;
      if (step.unlockTip) unlockTip.textContent = step.unlockTip;
      if (step.bubble) showBubble(step.bubble);

      if (navigator.vibrate) navigator.vibrate(40);
      fitUI();
    }

    function showBubble(text) {
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = text;
      document.body.appendChild(b);
      setTimeout(() => b.remove(), 1000);
    }

    const box = document.getElementById("giftBox");
    box.addEventListener("touchstart", function(e){ e.preventDefault(); openGift(); }, {passive:false});
    box.addEventListener("click", openGift);

    function burstSparkles() {
      const burst = document.getElementById("sparkBurst");
      burst.innerHTML = "";
      burst.style.display = "block";

      const symbols = ["‚ú®","‚≠ê","üíõ","üéÑ","‚ùÑÔ∏è","üéÅ","üß∏"];
      for (let i = 0; i < 24; i++) {
        const s = document.createElement("div");
        s.className = "spark";
        s.textContent = symbols[Math.floor(Math.random() * symbols.length)];
        s.style.setProperty("--x", (Math.random() * 300 - 150).toFixed(0) + "px");
        s.style.setProperty("--y", (Math.random() * 300 - 150).toFixed(0) + "px");
        s.style.left = "50%";
        s.style.top = "38%";
        burst.appendChild(s);
      }
      setTimeout(() => burst.style.display = "none", 900);
    }

    /* ===========================
       ‚ùÑÔ∏è Snow + sleigh trail (unchanged)
    ============================ */
    const canvas = document.getElementById("snow");
    const ctx = canvas.getContext("2d");
    let w, h;

    function resize(){
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    const flakes = [];
    const flakeCount = 120;
    for(let i=0;i<flakeCount;i++){
      flakes.push({
        x: Math.random()*w,
        y: Math.random()*h,
        r: Math.random()*3+1,
        d: Math.random()*1+.5,
        s: Math.random()*1.4+.6
      });
    }

    const trail = [];
    const trailSymbols = ["‚ú®","‚≠ê","üíõ","‚ùÑÔ∏è"];
    let lastTrailSpawn = 0;

    function spawnTrailParticle() {
      const sleigh = document.getElementById("santaSleigh");
      if (!sleigh) return;

      const r = sleigh.getBoundingClientRect();
      const x = r.left + 40;
      const y = r.top + r.height - 25;

      trail.push({
        x, y,
        vx: -0.6 - Math.random()*1.1,
        vy: 0.2 + Math.random()*0.7,
        life: 1,
        size: 18 + Math.random()*6,
        spin: (Math.random()*0.12 - 0.06),
        rot: Math.random()*Math.PI*2,
        sym: trailSymbols[Math.floor(Math.random()*trailSymbols.length)]
      });

      if (trail.length > 140) trail.splice(0, trail.length - 140);
    }

    function drawSnowAndTrail(time){
      ctx.clearRect(0,0,w,h);

      ctx.fillStyle="rgba(255,255,255,0.85)";
      ctx.beginPath();
      for(let i=0;i<flakeCount;i++){
        const f = flakes[i];
        ctx.moveTo(f.x,f.y);
        ctx.arc(f.x,f.y,f.r,0,Math.PI*2,true);
      }
      ctx.fill();

      for(let i=0;i<flakeCount;i++){
        const f = flakes[i];
        f.y += Math.pow(f.d,1.2);
        f.x += Math.sin(f.y*0.01)*f.s;
        if(f.y > h){
          f.y = -10;
          f.x = Math.random()*w;
        }
      }

      if (document.body.classList.contains("finalChristmas")) {
        if (time - lastTrailSpawn > 90) {
          lastTrailSpawn = time;
          spawnTrailParticle();
        }

        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        for (let i = trail.length - 1; i >= 0; i--) {
          const p = trail[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.015;
          p.vx *= 0.992;
          p.life -= 0.02;
          p.rot += p.spin;

          if (p.life <= 0) {
            trail.splice(i, 1);
            continue;
          }

          const alpha = Math.max(0, p.life);
          ctx.globalAlpha = alpha;

          ctx.font = `${p.size}px system-ui`;
          ctx.shadowBlur = 18;
          ctx.shadowColor = "rgba(255,220,160,0.6)";

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillText(p.sym, 0, 0);
          ctx.restore();
        }

        ctx.restore();
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
      }

      requestAnimationFrame(drawSnowAndTrail);
    }

    requestAnimationFrame(drawSnowAndTrail);
  </script>
</body>
</html>
